RegExp.escape=function(a){return a.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")},function(a){"use strict";var b;b="undefined"!=typeof jQuery&&jQuery?jQuery:{},b.csv={defaults:{separator:",",delimiter:'"',headers:!0},hooks:{castToScalar:function(a){var b=/\./;if(isNaN(a))return a;if(b.test(a))return parseFloat(a);var c=parseInt(a);return isNaN(c)?null:c}},parsers:{parse:function(b,c){function d(){if(j=0,k="",c.start&&c.state.rowNum<c.start)return i=[],c.state.rowNum++,void(c.state.colNum=1);if(c.onParseEntry===a)h.push(i);else{var b=c.onParseEntry(i,c.state);b!==!1&&h.push(b)}i=[],c.end&&c.state.rowNum>=c.end&&(l=!0),c.state.rowNum++,c.state.colNum=1}function e(){if(c.onParseValue===a)i.push(k);else{var b=c.onParseValue(k,c.state);b!==!1&&i.push(b)}k="",j=0,c.state.colNum++}var f=c.separator,g=c.delimiter;c.state.rowNum||(c.state.rowNum=1),c.state.colNum||(c.state.colNum=1);var h=[],i=[],j=0,k="",l=!1,m=RegExp.escape(f),n=RegExp.escape(g),o=/(D|S|\r\n|\n|\r|[^DS\r\n]+)/,p=o.source;return p=p.replace(/S/g,m),p=p.replace(/D/g,n),o=RegExp(p,"gm"),b.replace(o,function(a){if(!l)switch(j){case 0:if(a===f){k+="",e();break}if(a===g){j=1;break}if(/^(\r\n|\n|\r)$/.test(a)){e(),d();break}k+=a,j=3;break;case 1:if(a===g){j=2;break}k+=a,j=1;break;case 2:if(a===g){k+=a,j=1;break}if(a===f){e();break}if(/^(\r\n|\n|\r)$/.test(a)){e(),d();break}throw new Error("CSVDataError: Illegal State [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]");case 3:if(a===f){e();break}if(/^(\r\n|\n|\r)$/.test(a)){e(),d();break}if(a===g)throw new Error("CSVDataError: Illegal Quote [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]");throw new Error("CSVDataError: Illegal Data [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]");default:throw new Error("CSVDataError: Unknown State [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]")}}),0!==i.length&&(e(),d()),h},splitLines:function(b,c){function d(){if(h=0,c.start&&c.state.rowNum<c.start)return i="",void c.state.rowNum++;if(c.onParseEntry===a)g.push(i);else{var b=c.onParseEntry(i,c.state);b!==!1&&g.push(b)}i="",c.end&&c.state.rowNum>=c.end&&(j=!0),c.state.rowNum++}var e=c.separator,f=c.delimiter;c.state.rowNum||(c.state.rowNum=1);var g=[],h=0,i="",j=!1,k=RegExp.escape(e),l=RegExp.escape(f),m=/(D|S|\n|\r|[^DS\r\n]+)/,n=m.source;return n=n.replace(/S/g,k),n=n.replace(/D/g,l),m=RegExp(n,"gm"),b.replace(m,function(a){if(!j)switch(h){case 0:if(a===e){i+=a,h=0;break}if(a===f){i+=a,h=1;break}if("\n"===a){d();break}if(/^\r$/.test(a))break;i+=a,h=3;break;case 1:if(a===f){i+=a,h=2;break}i+=a,h=1;break;case 2:var b=i.substr(i.length-1);if(a===f&&b===f){i+=a,h=1;break}if(a===e){i+=a,h=0;break}if("\n"===a){d();break}if("\r"===a)break;throw new Error("CSVDataError: Illegal state [Row:"+c.state.rowNum+"]");case 3:if(a===e){i+=a,h=0;break}if("\n"===a){d();break}if("\r"===a)break;if(a===f)throw new Error("CSVDataError: Illegal quote [Row:"+c.state.rowNum+"]");throw new Error("CSVDataError: Illegal state [Row:"+c.state.rowNum+"]");default:throw new Error("CSVDataError: Unknown state [Row:"+c.state.rowNum+"]")}}),""!==i&&d(),g},parseEntry:function(b,c){function d(){if(c.onParseValue===a)g.push(i);else{var b=c.onParseValue(i,c.state);b!==!1&&g.push(b)}i="",h=0,c.state.colNum++}var e=c.separator,f=c.delimiter;c.state.rowNum||(c.state.rowNum=1),c.state.colNum||(c.state.colNum=1);var g=[],h=0,i="";if(!c.match){var j=RegExp.escape(e),k=RegExp.escape(f),l=/(D|S|\n|\r|[^DS\r\n]+)/,m=l.source;m=m.replace(/S/g,j),m=m.replace(/D/g,k),c.match=RegExp(m,"gm")}return b.replace(c.match,function(a){switch(h){case 0:if(a===e){i+="",d();break}if(a===f){h=1;break}if("\n"===a||"\r"===a)break;i+=a,h=3;break;case 1:if(a===f){h=2;break}i+=a,h=1;break;case 2:if(a===f){i+=a,h=1;break}if(a===e){d();break}if("\n"===a||"\r"===a)break;throw new Error("CSVDataError: Illegal State [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]");case 3:if(a===e){d();break}if("\n"===a||"\r"===a)break;if(a===f)throw new Error("CSVDataError: Illegal Quote [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]");throw new Error("CSVDataError: Illegal Data [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]");default:throw new Error("CSVDataError: Unknown State [Row:"+c.state.rowNum+"][Col:"+c.state.colNum+"]")}}),d(),g}},helpers:{collectPropertyNames:function(a){var b,c,d=[];for(b in a)for(c in a[b])a[b].hasOwnProperty(c)&&d.indexOf(c)<0&&"function"!=typeof a[b][c]&&d.push(c);return d}},toArray:function(c,d,e){var d=d!==a?d:{},f={};f.callback=e!==a&&"function"==typeof e?e:!1,f.separator="separator"in d?d.separator:b.csv.defaults.separator,f.delimiter="delimiter"in d?d.delimiter:b.csv.defaults.delimiter;var g=d.state!==a?d.state:{},d={delimiter:f.delimiter,separator:f.separator,onParseEntry:d.onParseEntry,onParseValue:d.onParseValue,state:g},h=b.csv.parsers.parseEntry(c,d);return f.callback?void f.callback("",h):h},toArrays:function(c,d,e){var d=d!==a?d:{},f={};f.callback=e!==a&&"function"==typeof e?e:!1,f.separator="separator"in d?d.separator:b.csv.defaults.separator,f.delimiter="delimiter"in d?d.delimiter:b.csv.defaults.delimiter;var g=[],d={delimiter:f.delimiter,separator:f.separator,onPreParse:d.onPreParse,onParseEntry:d.onParseEntry,onParseValue:d.onParseValue,onPostParse:d.onPostParse,start:d.start,end:d.end,state:{rowNum:1,colNum:1}};return d.onPreParse!==a&&d.onPreParse(c,d.state),g=b.csv.parsers.parse(c,d),d.onPostParse!==a&&d.onPostParse(g,d.state),f.callback?void f.callback("",g):g},toObjects:function(c,d,e){var d=d!==a?d:{},f={};f.callback=e!==a&&"function"==typeof e?e:!1,f.separator="separator"in d?d.separator:b.csv.defaults.separator,f.delimiter="delimiter"in d?d.delimiter:b.csv.defaults.delimiter,f.headers="headers"in d?d.headers:b.csv.defaults.headers,d.start="start"in d?d.start:1,f.headers&&d.start++,d.end&&f.headers&&d.end++;var g=[],h=[],d={delimiter:f.delimiter,separator:f.separator,onPreParse:d.onPreParse,onParseEntry:d.onParseEntry,onParseValue:d.onParseValue,onPostParse:d.onPostParse,start:d.start,end:d.end,state:{rowNum:1,colNum:1},match:!1,transform:d.transform},i={delimiter:f.delimiter,separator:f.separator,start:1,end:1,state:{rowNum:1,colNum:1}};d.onPreParse!==a&&d.onPreParse(c,d.state);var j=b.csv.parsers.splitLines(c,i),k=b.csv.toArray(j[0],d),g=b.csv.parsers.splitLines(c,d);d.state.colNum=1,d.state.rowNum=k?2:1;for(var l=0,m=g.length;m>l;l++){var n=b.csv.toArray(g[l],d),o={};for(var p in k)o[k[p]]=n[p];h.push(d.transform!==a?d.transform.call(a,o):o),d.state.rowNum++}return d.onPostParse!==a&&d.onPostParse(h,d.state),f.callback?void f.callback("",h):h},fromArrays:function(c,d,e){var d=d!==a?d:{},f={};f.callback=e!==a&&"function"==typeof e?e:!1,f.separator="separator"in d?d.separator:b.csv.defaults.separator,f.delimiter="delimiter"in d?d.delimiter:b.csv.defaults.delimiter;var g,h,i,j,k="";for(i=0;i<c.length;i++){for(g=c[i],h=[],j=0;j<g.length;j++){var l=g[j]===a||null===g[j]?"":g[j].toString();l.indexOf(f.delimiter)>-1&&(l=l.replace(f.delimiter,f.delimiter+f.delimiter));var m="\n|\r|S|D";m=m.replace("S",f.separator),m=m.replace("D",f.delimiter),l.search(m)>-1&&(l=f.delimiter+l+f.delimiter),h.push(l)}k+=h.join(f.separator)+"\r\n"}return f.callback?void f.callback("",k):k},fromObjects:function(c,d,e){var d=d!==a?d:{},f={};if(f.callback=e!==a&&"function"==typeof e?e:!1,f.separator="separator"in d?d.separator:b.csv.defaults.separator,f.delimiter="delimiter"in d?d.delimiter:b.csv.defaults.delimiter,f.headers="headers"in d?d.headers:b.csv.defaults.headers,f.sortOrder="sortOrder"in d?d.sortOrder:"declare",f.manualOrder="manualOrder"in d?d.manualOrder:[],f.transform=d.transform,"string"==typeof f.manualOrder&&(f.manualOrder=b.csv.toArray(f.manualOrder,f)),f.transform!==a){var g=c;c=[];var h;for(h=0;h<g.length;h++)c.push(f.transform.call(a,g[h]))}var i=b.csv.helpers.collectPropertyNames(c);if("alpha"===f.sortOrder&&i.sort(),f.manualOrder.length>0){var j,k=[].concat(f.manualOrder);for(j=0;j<i.length;j++)k.indexOf(i[j])<0&&k.push(i[j]);i=k}var l,j,m,n,o=[];for(f.headers&&o.push(i),l=0;l<c.length;l++){for(m=[],j=0;j<i.length;j++)n=i[j],m.push(n in c[l]&&"function"!=typeof c[l][n]?c[l][n]:"");o.push(m)}return b.csv.fromArrays(o,d,f.callback)}},b.csvEntry2Array=b.csv.toArray,b.csv2Array=b.csv.toArrays,b.csv2Dictionary=b.csv.toObjects,"undefined"!=typeof module&&module.exports&&(module.exports=b.csv)}.call(this),angular.module("config",[]).constant("ENV",{name:"development"}),angular.module("hoodFrequencyApp",["ngCookies","ngResource","ngSanitize","ngRoute","config"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:frequencyFile",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("hoodFrequencyApp").factory("frequencyLoader",["ENV",function(a){var b=function(b){return"development"==a.name?"static/frequencies/"+b:"hoodFrequency/static/frequencies/"+b},c=function(a){var b=$.csv.toArrays(a,{separator:"	"}),c={};return _(b).each(function(a){c[a[0]]=parseInt(a[1])}),c},d=function(a){var d=b(a),e=$.Deferred();return $.ajax({url:d,dataType:"text"}).success(function(a){e.resolve(c(a))}).error(function(a,b,c){console.warn("Failed to get frequency",c)}),e};return d}]),angular.module("hoodFrequencyApp").factory("hoodFrequencyCoordinator",function(){var a=function(a,b){var c=[];for(var d in b)c.push(b[d]);var e=_(c).reduce(function(a,b){return a+b},0),f=_(c).max();console.log("Total Frequency:",e),console.log("Max Frequency:",f);var g={};for(var d in b)g[d]=b[d]/f;var h=function(a){_(a).each(function(a){a.totalFrequency=e,a.maxFrequency=f,a.frequency=b[a.slug],a.normalizedFrequency=g[a.slug]})};h(a,b)};return a}),angular.module("hoodFrequencyApp").factory("hoodLoader",["ENV",function(a){var b=function(a){return _(a).map(function(a){return $.getJSON(a)})},c=function(b){return"development"==a.name?"static/manhattan/"+b+".json":"hoodFrequency/static/manhattan/"+b+".json"},d=function(a){var d=_(a).map(function(a){return c(a)}),e=b(d),f=$.Deferred(),g=e.length>1;return $.when.apply($,e).done(function(){var a=null;a=g?_(arguments).map(function(a){return a[0]}):[arguments[0]],f.resolve(a)}),f};return d}]),angular.module("hoodFrequencyApp").factory("hoodDirectory",function(){var a=["east-village","clinton","gramercy","hamilton-heights","chinatown","stuyvesant-town-cooper-village","battery-park-city-lower-manhattan","yorkville","midtown-midtown-south","washington-heights-north","turtle-bay-east-midtown","lenox-hill-roosevelt-island","murray-hill-kips-bay","upper-east-side-carnegie-hill","lower-east-side","central-harlem-north-polo-grounds","east-harlem-south","upper-west-side","lincoln-square","washington-heights-south","central-harlem-south","soho-tribeca-civic-center-little-italy","west-village","hudson-yards-chelsea-flatiron-union-square","manhattanville","morningside-heights","east-harlem-north","marble-hill-inwood","park-cemetery-etc-manhattan"];return{manhattan:a}}),angular.module("hoodFrequencyApp").factory("hoodRenderer",function(){var HoodRenderer={getMinPointFromPoints:function(a){var b=_.min(a,function(a){return a[0]})[0],c=_.min(a,function(a){return-a[1]})[1];return[b,c]},getMinPointFromGeom:function(a){var b=a.coordinates,c=99999999,d=0;return _(b).each(function(a){var b=this.getMinPointFromPoints(a[0]);c>b[0]&&(c=b[0]),d<b[1]&&(d=b[1])},this),[c,d]},getMinPointForAll:function(a){var b=_(a).map(function(a){return this.getMinPointFromGeom(a)},this);return this.getMinPointFromPoints(b)},drawRing:function(scope,points,minPoint,scale){var scaledPoints=_(points).map(function(a){var b=[a[0]-minPoint[0],minPoint[1]-a[1]];return[b[0]*scale,b[1]*scale]});with(scope){var pathFromArray=new Path({segments:scaledPoints,selected:!1,closed:!0});return pathFromArray}},drawHood:function(a,b,c,d){var e=b.geometry.coordinates;return c=c||this.getMinPointFromGeom(b.geometry),_(e).map(function(e){var f=this.drawRing(a,e[0],c,d);return f.data=b,f},this)},colorHood:function(a){_(a.paths).each(function(b){var c=1-a.normalizedFrequency;b.fillColor=new paper.Color(c,c,c),b.strokeColor="black"})},drawHoods:function(a,b,c,d){paper.clear();var e=paper.setup(c),f=_(b).map(function(a){return a.geometry}),g=this.getMinPointForAll(f);d=d||1/38,_(b).each(function(a){a.paths=this.drawHood(e,a,g,d)},this),_(b).each(function(a){this.colorHood(a)},this),this._handleMouseEvents(e,a),e.view.draw()},_handleMouseEvents:function(a,b){var c=new a.Tool,d=null;c.onMouseMove=function(a){a.item?(d!=a.item&&b.$emit("hood.selected",a.item.data),d=a.item):(d&&b.$emit("hood.deselected"),d=null)}}};return function(a,b,c){HoodRenderer.drawHoods(a,b,c)}}),angular.module("hoodFrequencyApp").controller("MainCtrl",["$scope","$routeParams","hoodDirectory",function(a,b,c){a.hoods=c.manhattan,a.frequencyFile=b.frequencyFile||"knicks",a.isActive=function(b){return a.frequencyFile===b?"active":void 0},a.tailStyle={visibility:"hidden"},a.updateTail=function(a){this.tailStyle=this.hood?{left:a.pageX+20,top:a.pageY}:{visibility:"hidden"}},a.$on("hood.selected",function(a,b){a.currentScope.hood=b}),a.$on("hood.deselected",function(a){a.currentScope.hood=null})}]),angular.module("hoodFrequencyApp").directive("renderer",["hoodLoader","hoodRenderer","frequencyLoader","hoodFrequencyCoordinator",function(a,b,c,d){return{restrict:"A",template:"<canvas class='hoods'></canvas>",link:function(e,f){console.log("Rendering: ",e.frequencyFile),a(e.hoods).done(function(a){c(e.frequencyFile).done(function(c){d(a,c),b(e,a,f.find("canvas")[0])})})}}}]);