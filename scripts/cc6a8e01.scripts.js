"use strict";angular.module("hoodFrequencyApp",["ngCookies","ngResource","ngSanitize","ngRoute"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/:frequencyFile",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("hoodFrequencyApp").factory("frequencyLoader",function(){var a=function(a){return"/scripts/static/frequencies/"+a},b=function(a){var b=$.csv.toArrays(a,{separator:"	"}),c={};return _(b).each(function(a){c[a[0]]=parseInt(a[1])}),c},c=function(c){var d=a(c),e=$.Deferred();return $.ajax({url:d,dataType:"text"}).success(function(a){e.resolve(b(a))}).error(function(a,b,c){console.warn("Failed to get frequency",c)}),e};return c}),angular.module("hoodFrequencyApp").factory("hoodFrequencyCoordinator",function(){var a=function(a,b){var c=[];for(var d in b)c.push(b[d]);var e=_(c).reduce(function(a,b){return a+b},0),f=_(c).max();console.log("Total Frequency:",e),console.log("Max Frequency:",f);var g={};for(var d in b)g[d]=b[d]/f;var h=function(a){_(a).each(function(a){a.totalFrequency=e,a.maxFrequency=f,a.frequency=b[a.slug],a.normalizedFrequency=g[a.slug]})};h(a,b)};return a}),angular.module("hoodFrequencyApp").factory("hoodLoader",function(){var a=function(a){return _(a).map(function(a){return $.getJSON(a)})},b=function(a){return"/scripts/static/manhattan/"+a+".json"},c=function(c){var d=_(c).map(function(a){return b(a)}),e=a(d),f=$.Deferred(),g=e.length>1;return $.when.apply($,e).done(function(){var a=null;a=g?_(arguments).map(function(a){return a[0]}):[arguments[0]],f.resolve(a)}),f};return c}),angular.module("hoodFrequencyApp").factory("hoodDirectory",function(){var a=["east-village","clinton","gramercy","hamilton-heights","chinatown","stuyvesant-town-cooper-village","battery-park-city-lower-manhattan","yorkville","midtown-midtown-south","washington-heights-north","turtle-bay-east-midtown","lenox-hill-roosevelt-island","murray-hill-kips-bay","upper-east-side-carnegie-hill","lower-east-side","central-harlem-north-polo-grounds","east-harlem-south","upper-west-side","lincoln-square","washington-heights-south","central-harlem-south","soho-tribeca-civic-center-little-italy","west-village","hudson-yards-chelsea-flatiron-union-square","manhattanville","morningside-heights","east-harlem-north","marble-hill-inwood","park-cemetery-etc-manhattan"];return{manhattan:a}}),angular.module("hoodFrequencyApp").factory("hoodRenderer",function(){var HoodRenderer={getMinPointFromPoints:function(a){var b=_.min(a,function(a){return a[0]})[0],c=_.min(a,function(a){return-a[1]})[1];return[b,c]},getMinPointFromGeom:function(a){var b=a.coordinates,c=99999999,d=0;return _(b).each(function(a){var b=this.getMinPointFromPoints(a[0]);c>b[0]&&(c=b[0]),d<b[1]&&(d=b[1])},this),[c,d]},getMinPointForAll:function(a){var b=_(a).map(function(a){return this.getMinPointFromGeom(a)},this);return this.getMinPointFromPoints(b)},drawRing:function(scope,points,minPoint,scale){var scaledPoints=_(points).map(function(a){var b=[a[0]-minPoint[0],minPoint[1]-a[1]];return[b[0]*scale,b[1]*scale]});with(scope){var pathFromArray=new Path({segments:scaledPoints,selected:!1,closed:!0});return pathFromArray}},drawHood:function(a,b,c,d){var e=b.geometry.coordinates;return c=c||this.getMinPointFromGeom(b.geometry),_(e).map(function(e){var f=this.drawRing(a,e[0],c,d);return f.data=b,f},this)},colorHood:function(a){_(a.paths).each(function(b){var c=1-a.normalizedFrequency;b.fillColor=new paper.Color(c,c,c),b.strokeColor="black"})},drawHoods:function(a,b,c,d){paper.clear();var e=paper.setup(c),f=_(b).map(function(a){return a.geometry}),g=this.getMinPointForAll(f);d=d||1/32,_(b).each(function(a){a.paths=this.drawHood(e,a,g,d)},this),_(b).each(function(a){this.colorHood(a)},this),this._handleMouseEvents(e,a),e.view.draw()},_handleMouseEvents:function(a,b){var c=new a.Tool,d=null;c.onMouseMove=function(a){a.item?(d!=a.item&&b.$emit("hood.selected",a.item.data),d=a.item):(d&&b.$emit("hood.deselected"),d=null)}}};return function(a,b,c){HoodRenderer.drawHoods(a,b,c)}}),angular.module("hoodFrequencyApp").controller("MainCtrl",["$scope","$routeParams","hoodDirectory",function(a,b,c){a.hoods=c.manhattan,a.frequencyFile=b.frequencyFile||"knicks",a.isActive=function(b){return a.frequencyFile===b?"active":void 0},a.tailStyle={visibility:"hidden"},a.updateTail=function(a){this.tailStyle=this.hood?{left:a.pageX+20,top:a.pageY}:{visibility:"hidden"}},a.$on("hood.selected",function(a,b){a.currentScope.hood=b}),a.$on("hood.deselected",function(a){a.currentScope.hood=null})}]),angular.module("hoodFrequencyApp").directive("renderer",["hoodLoader","hoodRenderer","frequencyLoader","hoodFrequencyCoordinator",function(a,b,c,d){return{restrict:"A",template:"<canvas class='hoods'></canvas>",link:function(e,f){console.log("Rendering: ",e.frequencyFile),a(e.hoods).done(function(a){c(e.frequencyFile).done(function(c){d(a,c),b(e,a,f.find("canvas")[0])})})}}}]);